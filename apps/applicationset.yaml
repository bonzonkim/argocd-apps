apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: appset
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  preserveResourcesOnDeletion: true

  generators:
    # 1. Helm Applications (chart exists) - Uses Global Template
    - merge:
        mergeKeys:
          - path
        generators:
          - git:
              repoURL: 'https://github.com/bonzonkim/argocd-apps'
              revision: main
              directories:
                - path: '*/*'
                - path: 'apps/*'
                  exclude: true
                - path: 'bootstrap/*'
                  exclude: true
                - path: 'ip-bumgu-com/*'
                  exclude: true
                - path: '.git/*'
                  exclude: true
                - path: '.github/*'
                  exclude: true
              values:
                path: '{{ .path.path }}'
          - git:
              repoURL: 'https://github.com/bonzonkim/argocd-apps'
              revision: main
              files:
                - path: '*/*/config.json'
              values:
                path: '{{ trimSuffix "/config.json" .path.path }}'
      selector:
        matchExpressions:
          - key: chart
            operator: Exists

    # 2. Raw Applications (chart does not exist) - Uses Override Template
    - merge:
        mergeKeys:
          - path
        generators:
          - git:
              repoURL: 'https://github.com/bonzonkim/argocd-apps'
              revision: main
              directories:
                - path: '*/*'
                - path: 'apps/*'
                  exclude: true
                - path: 'bootstrap/*'
                  exclude: true
                - path: 'ip-bumgu-com/*'
                  exclude: true
                - path: '.git/*'
                  exclude: true
                - path: '.github/*'
                  exclude: true
              values:
                path: '{{ .path.path }}'
          - git:
              repoURL: 'https://github.com/bonzonkim/argocd-apps'
              revision: main
              files:
                - path: '*/*/config.json'
              values:
                path: '{{ trimSuffix "/config.json" .path.path }}'
      selector:
        matchExpressions:
          - key: chart
            operator: DoesNotExist
      template:
        metadata:
          name: '{{ default (printf "%s-%s" (index (splitList "/" .path.path) 0) (index (splitList "/" .path.path) 1)) .appName }}'
        spec:
          project: default
          sources:
            - repoURL: 'https://github.com/bonzonkim/argocd-apps'
              targetRevision: main
              path: '{{ .path.path }}'
            - repoURL: 'https://github.com/bonzonkim/argocd-apps'
              targetRevision: main
              ref: values
          destination:
            server: https://kubernetes.default.svc
            namespace: '{{ default (index (splitList "/" .path.path) 0) .namespace }}'
          syncPolicy:
            automated:
              prune: false
              selfHeal: true
            syncOptions:
              - CreateNamespace=true

  # Global Template (Default = Helm)
  template:
    metadata:
      name: '{{ default (printf "%s-%s" (index (splitList "/" .path.path) 0) (index (splitList "/" .path.path) 1)) .appName }}'
    spec:
      project: default
      sources:
        - repoURL: '{{ .repoURL }}'
          chart: '{{ .chart }}'
          targetRevision: '{{ .targetRevision }}'
          helm:
            releaseName: '{{ default .chart .releaseName }}'
            ignoreMissingValueFiles: true
            valueFiles:
              - '$values/{{ .path.path }}/values.yaml'
        - repoURL: 'https://github.com/bonzonkim/argocd-apps'
          targetRevision: main
          ref: values
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ default (index (splitList "/" .path.path) 0) .namespace }}'
      syncPolicy:
        automated:
          prune: false
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
