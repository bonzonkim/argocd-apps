apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: tools-podinfo # 이름을 용도에 맞게 podinfo로 수정했습니다.
  namespace: argocd
spec:
  project: default
  syncPolicy:
    automated:
      selfHeal: true
      prune: true # 관리되지 않는 리소스 정리를 위해 권장
    syncOptions:
      - CreateNamespace=true # htest 네임스페이스가 없으면 자동 생성
  sources:
    # 1. Helm 차트 소스
    - repoURL: 'https://stefanprodan.github.io/podinfo'
      chart: podinfo
      targetRevision: 6.3.5 # 3.0.1은 너무 구버전이라 최신 안정 버전을 추천해요.
      helm:
        # 아래 ref: values로 지정한 소스를 참조합니다.
        valueFiles:
          - $values/htest/values.yaml
    
    # 2. Values 파일이 있는 Git 저장소
    - repoURL: 'https://github.com/bonzonkim/argocd-apps'
      targetRevision: main
      ref: values # 위에서 $values로 참조하는 별칭입니다.

    # 3. 추가적인 Kustomize 매니페스트 (필요한 경우 유지)
    - repoURL: 'https://github.com/bonzonkim/argocd-apps'
      targetRevision: main
      path: htest
      # kustomize 소스가 helm 소스와 같은 htest 네임스페이스에 배포되도록 보장합니다.

  destination:
    server: 'https://kubernetes.default.svc'
    namespace: htest
